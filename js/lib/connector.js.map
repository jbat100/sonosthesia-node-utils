{"version":3,"sources":["../ts/lib/connector.ts"],"names":[],"mappings":"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","file":"connector.js","sourcesContent":["\r\n//\r\n\r\nimport * as net from 'net';\r\nimport * as _ from 'underscore';\r\nimport * as Q from 'q';\r\nimport * as Rx from 'rx';\r\nimport {EventEmitter} from 'eventemitter3';\r\n\r\nimport {NativeClass, Message, MessageContentParser, IConnection, GUID} from './core';\r\nimport {HubMessage} from \"./messaging\";\r\n\r\nconst LineInputStream = require('line-input-stream');\r\n\r\n/**\r\n * TCPConnector runs server side and spawns TCPConnection instances upon incoming socket connections\r\n */\r\n\r\nexport class TCPConnector extends NativeClass {\r\n\r\n    readonly verbose = true;\r\n    private _error : Error;\r\n    private _server : net.Server;\r\n    private _connections : TCPConnection[] = [];\r\n    private _emitter : any = new EventEmitter();\r\n\r\n    constructor(private _parser : MessageContentParser)\r\n    {\r\n        super();\r\n    }\r\n\r\n    get server() { return this._server; }\r\n    get error() { return this._error; }\r\n    get emitter() { return this._emitter; }\r\n    get parser() { return this._parser; }\r\n\r\n    start(port) : Q.Promise<void> {\r\n        return Q.Promise((resolve, reject) => {\r\n            if (this.server) return reject(new Error('connector is already started'));\r\n            console.info(this.tag + ' start on port ' + port);\r\n            this._server = net.createServer((socket) => {\r\n                const connection = new TCPConnection(this, socket, this.parser);\r\n                this._connections.push(connection);\r\n                this.emitter.emit('connection', connection);\r\n            });\r\n            // try reconnect on server error (usually port is taken, address in use)\r\n            this.server.on('error', (err : any) => {\r\n                console.error(this.tag + ' server error ' + err.type + ' ' + err.message);\r\n                reject(err);\r\n                this._error = err;\r\n                this.emitter.emit('error', err);\r\n                this.stop();\r\n            });\r\n            this.server.on('close', () => {\r\n                console.error(this.tag + ' server close');\r\n                reject(new Error('closed'));\r\n                this.stop();\r\n            });\r\n            this.server.on('listening', () => {\r\n                console.info(this.tag + ' server listening on port ' + port);\r\n                resolve(null);\r\n                this._error = null;\r\n                this.emitter.emit('start');\r\n            });\r\n            // actually start the server\r\n            this.server.listen(port);\r\n            console.info(this.tag + ' created server listening on port ' + port);\r\n        }).catch((err) => {\r\n            this._error = err;\r\n            console.error(this.tag + ' could not create server on port ', port, err.message);\r\n            this.emitter.emit('error', err);\r\n            this.stop().then(() => {\r\n                throw err;\r\n            });\r\n        });\r\n    }\r\n\r\n    stop() : Q.Promise<void> {\r\n        return Q().then(() => {\r\n            if (this.server) {\r\n                this.server.removeAllListeners();\r\n                this.server.close();\r\n                this._server = null;\r\n                this.emitter.emit('stop');\r\n            }\r\n        });\r\n    }\r\n\r\n    destroyConnection(connection) {\r\n        console.warn(this.tag + ' destroying connection!');\r\n        this._connections = _.without(this._connections, connection);\r\n        this.emitter.emit('disconnection', connection);\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * TCPConnection can be used both with an associated connector (when running as server) and without\r\n * (when running as a client)\r\n */\r\n\r\n\r\nexport class TCPConnection extends NativeClass implements IConnection {\r\n\r\n    readonly verbose = true;\r\n\r\n    private _lineInputStream : any;\r\n\r\n    private _messageSubject : Rx.Subject<Message> = new Rx.Subject<Message>();\r\n    private _messageObservable: Rx.Observable<Message> = this._messageSubject.asObservable();\r\n\r\n    private _identifier : string;\r\n\r\n    constructor(private _connector : TCPConnector,\r\n                private _socket : net.Socket,\r\n                private _parser : MessageContentParser) {\r\n        super();\r\n        this._identifier = GUID.generate();\r\n        console.info(this.tag + ' initializing : ' + this.socket.remoteAddress +':'+ this.socket.remotePort);\r\n\r\n        // destroy connection on socket close or error\r\n        this.socket.on('close', () => {\r\n            console.info(this.tag + ' socket closed');\r\n            if (this.connector) this.connector.destroyConnection(this);\r\n        });\r\n        // we NEED the error handler, otherwise it bubbles up and causes the server to crash\r\n        this.socket.on('error', (err : any) => {\r\n            console.error(this.tag + ' socket error ' + err.type + ' ' + err.message);\r\n            if (this.connector) this.connector.destroyConnection(this);\r\n        });\r\n\r\n        // setup a line input stream with the json delimiter and parse json objects\r\n        this._lineInputStream = LineInputStream(this.socket);\r\n        this._lineInputStream.setEncoding('utf8');\r\n        this._lineInputStream.setDelimiter(this.jsonDelimiter);\r\n        this._lineInputStream.on('line', (line : any) => {\r\n            if (line && line.length) {\r\n                try {\r\n                    //console.info(this.tag + ' parsed json');\r\n                    const obj = JSON.parse(line);\r\n                    this._messageSubject.onNext(HubMessage.newFromJSON(obj, this.parser));\r\n                } catch (err) {\r\n                    console.error(this.tag + ' json parsing error : ' + err.stack);\r\n                }\r\n            }\r\n        });\r\n        this._lineInputStream.on('error', err => {\r\n            console.error(this.tag + ' line input stream error : ' + err.message);\r\n        });\r\n\r\n    }\r\n\r\n    get tag() : string { return this.constructor.name + ' (' + this.identifier.substr(0, 10) + '...)'; }\r\n    get identifier() : string { return this._identifier; }\r\n    get jsonDelimiter() : string { return '__json_delimiter__'; }\r\n    get messageObservable() : Rx.Observable<Message> { return this._messageObservable; }\r\n    get socket() : net.Socket { return this._socket; }\r\n    get connector() : TCPConnector { return this._connector; }\r\n    get parser() : MessageContentParser { return this._parser; }\r\n\r\n    sendJSON(obj : any) {\r\n        const str = this.jsonDelimiter + JSON.stringify(obj) + this.jsonDelimiter;\r\n        if (this.verbose) console.info(this.tag + ' sending : ' + str);\r\n        this.socket.write(str);\r\n    }\r\n\r\n    sendMessage(message : Message) {\r\n        this.sendJSON(message.toJSON());\r\n    }\r\n\r\n}\r\n"]}